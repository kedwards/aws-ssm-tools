#!/usr/bin/env bash
set -euo pipefail

# Resolve symlinks to get the real script location
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
ROOT_DIR="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"

# Core
source "$ROOT_DIR/lib/core/logging.sh"
source "$ROOT_DIR/lib/core/flags.sh"
source "$ROOT_DIR/lib/core/tty.sh"

# Menu
source "$ROOT_DIR/lib/menu/index.sh"

# AWS Auth
source "$ROOT_DIR/lib/core/aws_auth.sh"

# AWS Helpers
source "$ROOT_DIR/lib/core/aws.sh"
source "$ROOT_DIR/lib/core/commands.sh"
source "$ROOT_DIR/lib/aws/ec2.sh"
source "$ROOT_DIR/lib/aws/ssm.sh"

# Commands
source "$ROOT_DIR/lib/commands/ssm_connect.sh"
source "$ROOT_DIR/lib/commands/ssm_list.sh"
source "$ROOT_DIR/lib/commands/ssm_kill.sh"
source "$ROOT_DIR/lib/commands/ssm_exec.sh"

usage() {
  cat <<EOF
Usage: ssm <command> [options]

AWS Systems Manager (SSM) session management tool

Commands:
  connect    Start SSM shell session or port forwarding to an instance
  exec       Run a shell command on one or more instances via SSM
  list       List active SSM sessions on this host
  kill       Terminate active SSM sessions

Options:
  -h, --help Show this help message

Run 'ssm <command> --help' for more information on a specific command.
EOF
}

main() {
  local cmd="${1:-}"
  
  # Handle help or no command
  if [[ -z "$cmd" ]] || [[ "$cmd" == "-h" ]] || [[ "$cmd" == "--help" ]]; then
    usage
    [[ -z "$cmd" ]] && exit 1 || exit 0
  fi
  
  shift || true

  case "$cmd" in
    connect)
      ssm_connect "$@"
      ;;
    exec)
      ssm_exec "$@"
      ;;
    list)
      ssm_list "$@"
      ;;
    kill)
      ssm_kill "$@"
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      exit 1
      ;;
  esac
}

main "$@"
