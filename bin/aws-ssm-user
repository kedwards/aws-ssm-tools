#!/bin/bash

# Wrapper script to set up qp user via aws-ssm-exec
# Usage: 
#   ./setup-qp-user-ssm.sh                    # interactive instance selection
#   ./setup-qp-user-ssm.sh i-0478d2123758ec730  # specific instance
#   ./setup-qp-user-ssm.sh Singleton          # instance by name

set -euo pipefail

USER=qp
SSH_PUBLIC_KEY=$(cat ~/.ssh/id_rsa.pub)

# Build the command to execute - must work in a single bash -c invocation
SETUP_COMMAND="USERNAME=qp; SSH_KEY='${SSH_PUBLIC_KEY}'; if ! id \$USERNAME &>/dev/null; then useradd -m -s /bin/bash \$USERNAME && echo User \$USERNAME created; else echo User \$USERNAME already exists; fi; mkdir -p /home/\$USERNAME/.ssh && chmod 700 /home/\$USERNAME/.ssh && echo \$SSH_KEY > /home/\$USERNAME/.ssh/authorized_keys && chmod 600 /home/\$USERNAME/.ssh/authorized_keys && chown -R \$USERNAME:\$USERNAME /home/\$USERNAME/.ssh && printf '%s ALL=(ALL) NOPASSWD: ALL\n' \$USERNAME > /etc/sudoers.d/user_temp_access && chmod 440 /etc/sudoers.d/user_temp_access && echo Setup complete for user \$USERNAME with sudo access"

# Execute via aws-ssm-exec
~/.local/bin/aws-ssm-exec "$SETUP_COMMAND" "$@"
